<?xml version="1.0" encoding="UTF-8"?>
<integrador>
	<files>	
		<login>
			<usuario>
				<login>
					<data>
						select
							pf.parcodigo as id,
							gp.parnome as nome,
							pf.funadministra as administrador
						from genparcei gp
							inner join pesfuncio pf on (gp.parcodigo = pf.parcodigo and pf.funadministra = 'S')
						where cast(pf.funusuario as varchar(15))  = :FUNUSUARIO
							and cast(pf.funsenhaapp as varchar(10)) = :FUNSENHAAPP
					</data>
				</login>
			</usuario>
		</login>
		<query>
			<atualiza_viagem>
				<viagem>
					<update>
						<data>
							update rviviagem set 
								parnome = :MOTORISTA, 
								VIADESTINO = :DESTINO,
								VIAFINALIDADE = :FINALIDADE,
								TRACODIGO = :TRANSPORTE,
								VIADATSAIDA = :DATASAIDA,
								VIADATREGRESSO = :DATAREGRESSO
							where viacodigo = :ID
						</data>				
					</update>
				</viagem>
			</atualiza_viagem>
			<cadastra_viagem>
				<insercao>
					<insert>
						<data>
							INSERT INTO RVIVIAGEM (
                                VIACODIGO, 
                                EMPCODIGO, 
                                PARNOME,
                                TRACODIGO, 
                                VIADESTINO, 
                                VIAFINALIDADE, 
                                VIAACOMPANHANTES, 
                                VIADATSAIDA, 
                                VIADATREGRESSO, 
                                PARCODIGOINC, 
                                VIAOBSERVACAO) 
                            VALUES (
                                (select coalesce(max(viacodigo),0) + 1 from rviviagem), 
                                :EMPRESA, 
                                :MOTORISTA, 
                                :TRANSPORTE, 
                                :DESTINO, 
                                :FINALIDADE, 
                                :ACOMPANHANTES, 
                                :DATASAIDA, 
                                :DATAREGRESSO, 
                                :RESPONSAVEL, 
                                :OBSERVACAO) 
						</data>
					</insert>
				</insercao>
			</cadastra_viagem>
			<deleta_viagem>
				<viagem>
					<delete>
						<data>
							delete from rviviagem where viacodigo = :ID
						</data>
					</delete>
				</viagem>
				<despesa>
					<delete>
						<data>
							delete from rvidespesa where viacodigo = :ID
						</data>
					</delete>
				</despesa>
			</deleta_viagem>
			<cadastra_despesa>
				<insercao>
					<insert>
						<data>
							INSERT INTO RVIDESPESA(
								VIACODIGO, 
								DESCODIGO, 
								DESNOME, 
								DESDATA, 
								DESNOTA, 
								DESFORNECEDOR, 
								DESLOCAL, 
								DESVALOR) 
							VALUES(
								:VIAGEM, 
								(select coalesce(max(descodigo),0) + 1 from rvidespesa where viacodigo = :VIAGEM), 
								:NOME, 
								:DATA, 
								:NOTA, 
								:FORNECEDOR, 
								:LOCAL, 
								:VALOR);
						</data>
					</insert>
				</insercao>
			</cadastra_despesa>
			<atualiza_despesa>
				<despesa>
					<update>
						<data>
							UPDATE RVIDESPESA SET 
								DESNOME = :NOME,
								DESDATA = :DATA,
								DESNOTA = :NOTA,
								DESFORNECEDOR = :FORNECEDOR,
								DESLOCAL = :LOCAL,
								DESVALOR = :VALOR
							WHERE VIACODIGO = :VIAGEM 
								AND DESCODIGO = :ID
						</data>				
					</update>
				</despesa>
			</atualiza_despesa>
			<deleta_despesa>
				<despesa>
					<delete>
						<data>
							delete from rvidespesa where viacodigo = :VIAGEM and descodigo = :ID
						</data>
					</delete>
				</despesa>
			</deleta_despesa>
			<getall>
				<viagem>
					<data>
						select FIRST :FIRST SKIP :SKIP
							r.viacodigo as ID,
							r.empcodigo as empresa,
							r.tracodigo as transporte,
							r.viadestino as destino,
							r.parnome as motorista,
							coalesce(r.viafinalidade,'Nenhuma finalidade relatada') as finalidade,
							coalesce(r.viaacompanhantes,'Não') as acompanhantes,
							r.viadatsaida as datasaida,
							r.viadatregresso as dataregresso,
							r.parcodigoinc as responsavel,
							coalesce(r.viaobservacao,'Sem observação') as observacao
						from rviviagem r
						order by r.viacodigo desc
					</data>
				</viagem>
				<despesa>
					<data>
						with viagem as (
							select FIRST :FIRST SKIP :SKIP
								r.viacodigo as ID
							from rviviagem r
							order by r.viacodigo desc
						)
						select
							d.viacodigo as viagem,
							d.descodigo as id,
							d.desnome as nome,
							d.desdata as data,
							d.desnota as nota,
							d.desfornecedor as fornecedor,
							d.deslocal as local,
							d.desvalor as valor
						from rvidespesa d
							inner join viagem v on (v.id = d.viacodigo)
						order by d.descodigo asc,desdata asc
					</data>
				</despesa>
				<transporte>
					<data>
						select t.tracodigo as id, t.tranome as nome from rvitransporte t
					</data>
				</transporte>
				<funcionarios>
					<data>
						select
							pf.parcodigo as id,
							gp.parnome as nome
						from genparcei gp
							inner join pesfuncio pf on (gp.parcodigo = pf.parcodigo and pf.funmotorista = 'S')
						order by gp.parnome
					</data>
				</funcionarios>
			</getall>
		</query>
	</files>		
</integrador>